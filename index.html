<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NVC自我同理日记</title>
  <!-- PWA配置 -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4F46E5">
  <!-- Apple PWA支持 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="NVC日记">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 配置Tailwind自定义主题 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5', // 深紫色作为主色调，代表平静和智慧
            secondary: '#EC4899', // 粉色作为辅助色，代表情感和同理
            neutral: '#6B7280', // 中性色
            light: '#F9FAFB', // 浅色背景
            dark: '#1F2937' // 深色文字
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'card': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
            'button': '0 4px 6px -1px rgba(79, 70, 229, 0.4), 0 2px 4px -1px rgba(79, 70, 229, 0.3)',
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.4s ease-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            }
          }
        },
      }
    }
  </script>
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .transition-all-300 {
        transition: all 300ms ease-in-out;
      }
    }
  </style>
  <!-- 全局样式 -->
  <style>
    body {
      background-color: #F9FAFB;
      background-image: 
        radial-gradient(at 40% 20%, rgba(79, 70, 229, 0.05) 0px, transparent 50%),
        radial-gradient(at 80% 0%, rgba(236, 72, 153, 0.05) 0px, transparent 50%),
        radial-gradient(at 0% 50%, rgba(79, 70, 229, 0.05) 0px, transparent 50%),
        radial-gradient(at 80% 50%, rgba(236, 72, 153, 0.05) 0px, transparent 50%),
        radial-gradient(at 0% 100%, rgba(79, 70, 229, 0.05) 0px, transparent 50%),
        radial-gradient(at 80% 100%, rgba(236, 72, 153, 0.05) 0px, transparent 50%),
        radial-gradient(at 0% 0%, rgba(79, 70, 229, 0.05) 0px, transparent 50%);
      background-attachment: fixed;
    }
    .form-focus {
      @apply focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300;
    }
    .btn-hover {
      @apply hover:shadow-lg hover:scale-105 transition-all duration-300 active:scale-95;
    }
    /* 修复日期输入框在移动设备上的宽度问题 */
    input[type="date"] {
      /* 确保输入框不会超出容器 */
      max-width: 100%;
      /* 移除iOS Safari的默认内边距和外观 */
      -webkit-appearance: none;
      /* 确保输入框内容不会溢出 */
      box-sizing: border-box;
    }
    /* 确保所有输入元素都正确响应 */
    .relative > input,
    .relative > textarea {
      /* 确保输入元素宽度计算正确 */
      box-sizing: border-box;
    }
  </style>
</head>
<body class="font-sans text-dark min-h-screen">
  <!-- 顶部导航栏 -->
  <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 fixed top-0 left-0 right-0 z-50 shadow-sm">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-heart-o text-secondary text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
          NVC自我同理日记
        </h1>
      </div>
      <div class="flex space-x-4">
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 transition-all duration-300">
          <i class="fa fa-moon-o text-neutral"></i>
        </button>
        <button id="history-btn" class="p-2 rounded-full hover:bg-gray-100 transition-all duration-300 relative">
          <i class="fa fa-history text-neutral"></i>
          <span id="history-count" class="absolute -top-1 -right-1 bg-secondary text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区域 -->
  <main class="container mx-auto px-4 pt-28 pb-20">
    <div class="max-w-3xl mx-auto">
      <!-- 日记卡片 -->
      <div class="bg-white rounded-xl shadow-card p-6 md:p-8 mb-8 animate-fade-in">
        <h2 class="text-xl md:text-2xl font-semibold mb-6 text-center">今天的同理练习</h2>
        
        <form id="journal-form" class="space-y-6">
          <!-- 日期选择 -->
          <div class="space-y-2">
            <label for="date" class="block text-sm font-medium text-gray-700">日期</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa fa-calendar text-neutral"></i>
              </div>
              <input type="date" id="date" name="date" 
                class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none form-focus bg-gray-50" 
                value="">
            </div>
          </div>

          <!-- 事件描述 -->
          <div class="space-y-2">
            <label for="event" class="block text-sm font-medium text-gray-700">发生了什么？（具体事件）</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa fa-file-text-o text-neutral"></i>
              </div>
              <textarea id="event" name="event" rows="3" 
                class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none form-focus" 
                placeholder="请详细描述发生的事件..."></textarea>
            </div>
          </div>

          <!-- 对象 -->
          <div class="space-y-2">
            <label for="object" class="block text-sm font-medium text-gray-700">对象</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa fa-user text-neutral"></i>
              </div>
              <input type="text" id="object" name="object" 
                class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none form-focus bg-gray-50" 
                placeholder="请输入事件涉及的对象...">
            </div>
          </div>

          <!-- 我的感受 -->
          <div class="space-y-2">
            <label for="my-feelings" class="block text-sm font-medium text-gray-700">我的感受是？</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa fa-smile-o text-neutral"></i>
              </div>
              <textarea id="my-feelings" name="my-feelings" rows="2" 
                class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none form-focus" 
                placeholder="我感到...（如：生气、失望、受伤等）"></textarea>
            </div>
          </div>

          <!-- 我的需要 -->
          <div class="space-y-2">
            <label for="my-needs" class="block text-sm font-medium text-gray-700">我的需要是？</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa fa-star-o text-neutral"></i>
              </div>
              <textarea id="my-needs" name="my-needs" rows="2" 
                class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none form-focus" 
                placeholder="我需要...（如：尊重、理解、支持等）"></textarea>
            </div>
          </div>

          <!-- 对方的感受 -->
          <div class="space-y-2">
            <label for="their-feelings" class="block text-sm font-medium text-gray-700">对方可能的感受是？</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa fa-users text-neutral"></i>
              </div>
              <textarea id="their-feelings" name="their-feelings" rows="2" 
                class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none form-focus" 
                placeholder="对方可能感到...（如：压力、焦虑、担心等）"></textarea>
            </div>
          </div>

          <!-- 对方的需要 -->
          <div class="space-y-2">
            <label for="their-needs" class="block text-sm font-medium text-gray-700">对方可能的需要是？</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa fa-heart text-neutral"></i>
              </div>
              <textarea id="their-needs" name="their-needs" rows="2" 
                class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none form-focus" 
                placeholder="对方可能需要...（如：认可、空间、帮助等）"></textarea>
            </div>
          </div>

          <!-- 同理后的感想 -->
          <div class="space-y-2">
            <label for="compassion-feelings" class="block text-sm font-medium text-gray-700">同理之后，我的感想是？</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa fa-lightbulb-o text-neutral"></i>
              </div>
              <textarea id="compassion-feelings" name="compassion-feelings" rows="3" 
                class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none form-focus" 
                placeholder="同理之后，我感到...（如：平静、理解、接纳等）"></textarea>
            </div>
          </div>

          <!-- 提交按钮 -->
          <div class="pt-4">
            <button type="submit" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 px-6 rounded-lg font-medium shadow-button btn-hover flex items-center justify-center space-x-2">
              <i class="fa fa-save"></i>
              <span>保存日记</span>
            </button>
          </div>
        </form>
      </div>

      <!-- 统计模块 -->
      <div id="stats-module" class="bg-white rounded-xl shadow-card p-6 md:p-8 mb-8 animate-slide-up">
        <h2 class="text-xl md:text-2xl font-semibold mb-6 text-center">日记记录统计</h2>
        
        <div class="mb-6">
          <div class="flex justify-between items-center mb-4">
            <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100 transition-all duration-300">
              <i class="fa fa-chevron-left text-neutral"></i>
            </button>
            <h3 id="current-month" class="font-medium text-lg"></h3>
            <button id="next-month" class="p-2 rounded-full hover:bg-gray-100 transition-all duration-300">
              <i class="fa fa-chevron-right text-neutral"></i>
            </button>
          </div>
          
          <div id="calendar-container" class="overflow-x-auto">
            <div id="calendar" class="min-w-[320px]">
              <!-- 日历标题行 -->
              <div class="grid grid-cols-7 text-center mb-2">
                <div class="text-sm font-medium text-gray-500">日</div>
                <div class="text-sm font-medium text-gray-500">一</div>
                <div class="text-sm font-medium text-gray-500">二</div>
                <div class="text-sm font-medium text-gray-500">三</div>
                <div class="text-sm font-medium text-gray-500">四</div>
                <div class="text-sm font-medium text-gray-500">五</div>
                <div class="text-sm font-medium text-gray-500">六</div>
              </div>
              <!-- 日历日期网格 -->
              <div id="calendar-days" class="grid grid-cols-7 gap-1 text-center"></div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-gray-50 p-4 rounded-lg text-center">
            <p class="text-sm text-gray-500 mb-1">总记录数</p>
            <p id="total-entries" class="text-2xl font-bold text-primary">0</p>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg text-center">
            <p class="text-sm text-gray-500 mb-1">本月记录</p>
            <p id="monthly-entries" class="text-2xl font-bold text-secondary">0</p>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg text-center">
            <p class="text-sm text-gray-500 mb-1">最长连续</p>
            <p id="streak-count" class="text-2xl font-bold text-green-500">0</p>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg text-center">
            <p class="text-sm text-gray-500 mb-1">完成率</p>
            <p id="completion-rate" class="text-2xl font-bold text-orange-500">0%</p>
          </div>
        </div>
      </div>

      <!-- 历史记录预览 -->
      <div id="recent-entries" class="bg-white rounded-xl shadow-card p-6 md:p-8 animate-slide-up">
        <h2 class="text-xl md:text-2xl font-semibold mb-6 text-center">最近的日记</h2>
        <div id="entries-container" class="space-y-4 max-h-64 overflow-y-auto pr-2">
          <!-- 这里会动态显示最近的日记条目 -->
          <div class="text-center text-neutral py-8">
            <i class="fa fa-book-open-o text-4xl mb-4 block text-gray-300"></i>
            <p>暂无日记记录，开始写第一篇吧！</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 历史记录模态框 -->
  <div id="history-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-lg max-w-3xl w-full max-h-[90vh] flex flex-col">
      <div class="p-6 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-xl font-semibold">日记历史</h3>
        <button id="close-modal" class="text-neutral hover:text-dark p-2 rounded-full hover:bg-gray-100 transition-all duration-300">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div id="modal-content" class="p-6 overflow-y-auto flex-grow">
        <!-- 这里会动态显示所有日记条目 -->
      </div>
      <div class="p-6 border-t border-gray-200 flex justify-end">
        <button id="export-btn" class="bg-primary text-white py-2 px-4 rounded-lg font-medium btn-hover mr-2 flex items-center space-x-2">
          <i class="fa fa-download"></i>
          <span>导出数据</span>
        </button>
        <button id="clear-history" class="bg-red-500 text-white py-2 px-4 rounded-lg font-medium btn-hover flex items-center space-x-2">
          <i class="fa fa-trash-o"></i>
          <span>清空历史</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 成功提示 -->
  <div id="success-toast" class="fixed bottom-4 right-4 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center space-x-2 z-50">
    <i class="fa fa-check-circle"></i>
    <span>日记保存成功！</span>
  </div>

  <!-- 脚本 -->
  <script>
    // DOM元素
    const journalForm = document.getElementById('journal-form');
    const dateInput = document.getElementById('date');
    const entriesContainer = document.getElementById('entries-container');
    const recentEntries = document.getElementById('recent-entries');
    const historyBtn = document.getElementById('history-btn');
    const historyModal = document.getElementById('history-modal');
    const closeModal = document.getElementById('close-modal');
    const modalContent = document.getElementById('modal-content');
    const historyCount = document.getElementById('history-count');
    const successToast = document.getElementById('success-toast');
    const exportBtn = document.getElementById('export-btn');
    const clearHistory = document.getElementById('clear-history');
    const themeToggle = document.getElementById('theme-toggle');

    // 设置默认日期为今天
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;

    // 存储键名
    const STORAGE_KEY = 'nvc-journal-entries';

    // 获取所有日记条目
    function getEntries() {
      const entries = localStorage.getItem(STORAGE_KEY);
      return entries ? JSON.parse(entries) : [];
    }

    // 保存日记条目
    function saveEntry(entry) {
      const entries = getEntries();
      entries.push(entry);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
      updateEntriesDisplay();
      showToast();
    }

    // 更新日记显示
    function updateEntriesDisplay() {
      const entries = getEntries();
      
      // 更新历史计数
      historyCount.textContent = entries.length;
      
      // 如果没有条目，显示空状态
      if (entries.length === 0) {
        entriesContainer.innerHTML = `
          <div class="text-center text-neutral py-8">
            <i class="fa fa-book-open-o text-4xl mb-4 block text-gray-300"></i>
            <p>暂无日记记录，开始写第一篇吧！</p>
          </div>
        `;
        return;
      }
      
      // 按日期降序排序
      entries.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // 显示最近的3条记录
      entriesContainer.innerHTML = '';
      const recent = entries.slice(0, 3);
      
      recent.forEach((entry, index) => {
        const formattedDate = formatDate(entry.date);
        const entryCard = document.createElement('div');
        entryCard.className = 'p-4 border border-gray-200 rounded-lg hover:shadow-md transition-all duration-300';
        entryCard.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h4 class="font-medium text-primary">${formattedDate}</h4>
            <span class="bg-primary/10 text-primary text-xs px-2 py-1 rounded-full">#${entries.length - index}</span>
          </div>
          ${entry.object ? `<p class="text-sm text-gray-500 mb-1">对象: <span class="text-gray-700">${entry.object}</span></p>` : ''}
          <p class="text-sm text-gray-600 line-clamp-2 mb-2">${entry.event}</p>
          <div class="flex flex-wrap gap-2">
            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">感受: ${truncateText(entry.myFeelings, 10)}</span>
            <span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded">需要: ${truncateText(entry.myNeeds, 10)}</span>
          </div>
        `;
        entriesContainer.appendChild(entryCard);
      });
    }

    // 显示所有历史记录
    function showAllEntries() {
      const entries = getEntries();
      
      if (entries.length === 0) {
        modalContent.innerHTML = `
          <div class="text-center text-neutral py-12">
            <i class="fa fa-book-open-o text-5xl mb-4 block text-gray-300"></i>
            <p class="text-lg">暂无日记记录</p>
          </div>
        `;
        return;
      }
      
      // 按日期降序排序
      entries.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      modalContent.innerHTML = '';
      
      entries.forEach((entry, index) => {
        const formattedDate = formatDate(entry.date);
        const entryCard = document.createElement('div');
        entryCard.className = 'p-5 border border-gray-200 rounded-lg mb-4 hover:shadow-md transition-all duration-300 animate-fade-in';
        entryCard.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <h4 class="font-medium text-primary text-lg">${formattedDate}</h4>
            <span class="bg-primary/10 text-primary text-xs px-2 py-1 rounded-full">#${entries.length - index}</span>
          </div>
          
          <div class="space-y-4">
            <div>
              <p class="text-sm text-gray-500 mb-1">发生了什么？</p>
              <p class="text-sm">${entry.event}</p>
            </div>
            ${entry.object ? `<div>
              <p class="text-sm text-gray-500 mb-1">对象</p>
              <p class="text-sm">${entry.object}</p>
            </div>` : ''}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-gray-500 mb-1">我的感受</p>
                <p class="text-sm">${entry.myFeelings}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 mb-1">我的需要</p>
                <p class="text-sm">${entry.myNeeds}</p>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-gray-500 mb-1">对方的感受</p>
                <p class="text-sm">${entry.theirFeelings}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 mb-1">对方的需要</p>
                <p class="text-sm">${entry.theirNeeds}</p>
              </div>
            </div>
            
            <div>
              <p class="text-sm text-gray-500 mb-1">同理之后的感想</p>
              <p class="text-sm italic">${entry.compassionFeelings}</p>
            </div>
          </div>
        `;
        modalContent.appendChild(entryCard);
      });
    }

    // 格式化日期
    function formatDate(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}年${month}月${day}日`;
    }

    // 截断文本
    function truncateText(text, maxLength) {
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }

    // 显示成功提示
    function showToast() {
      successToast.classList.remove('translate-y-20', 'opacity-0');
      
      setTimeout(() => {
        successToast.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }

    // 导出数据
    function exportData() {
      const entries = getEntries();
      if (entries.length === 0) {
        alert('没有数据可以导出');
        return;
      }
      
      const dataStr = JSON.stringify(entries, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `nvc-journal-export-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // 清空历史记录
    function clearAllEntries() {
      if (confirm('确定要清空所有日记记录吗？此操作不可恢复。')) {
        localStorage.removeItem(STORAGE_KEY);
        updateEntriesDisplay();
        showAllEntries();
        updateStats();
      }
    }

    // 统计模块相关函数
    let currentDate = new Date();
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const currentMonthEl = document.getElementById('current-month');
    const calendarDaysEl = document.getElementById('calendar-days');
    const totalEntriesEl = document.getElementById('total-entries');
    const monthlyEntriesEl = document.getElementById('monthly-entries');
    const streakCountEl = document.getElementById('streak-count');
    const completionRateEl = document.getElementById('completion-rate');

    // 更新统计信息
    function updateStats() {
      const entries = getEntries();
      const entriesByDate = {};
      
      // 构建日期索引
      entries.forEach(entry => {
        entriesByDate[entry.date] = true;
      });
      
      // 总记录数
      totalEntriesEl.textContent = entries.length;
      
      // 生成当前月份的日历
      generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
      
      // 计算本月记录数
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const monthlyCount = entries.filter(entry => {
        const entryDate = new Date(entry.date);
        return entryDate.getFullYear() === year && entryDate.getMonth() === month;
      }).length;
      monthlyEntriesEl.textContent = monthlyCount;
      
      // 计算最长连续记录
      const sortedDates = Object.keys(entriesByDate).sort();
      let maxStreak = 0;
      let currentStreak = 0;
      
      for (let i = 0; i < sortedDates.length; i++) {
        if (i === 0) {
          currentStreak = 1;
        } else {
          const prevDate = new Date(sortedDates[i-1]);
          const currDate = new Date(sortedDates[i]);
          const dayDiff = (currDate - prevDate) / (1000 * 60 * 60 * 24);
          
          if (dayDiff === 1) {
            currentStreak++;
          } else if (dayDiff > 1) {
            currentStreak = 1;
          }
        }
        maxStreak = Math.max(maxStreak, currentStreak);
      }
      streakCountEl.textContent = maxStreak;
      
      // 计算完成率（假设目标是每天写一篇）
      if (entries.length === 0) {
        completionRateEl.textContent = '0%';
      } else {
        const firstEntryDate = new Date(sortedDates[0]);
        const lastEntryDate = new Date(sortedDates[sortedDates.length - 1]);
        const totalDays = Math.ceil((lastEntryDate - firstEntryDate) / (1000 * 60 * 60 * 24)) + 1;
        const rate = Math.round((entries.length / totalDays) * 100);
        completionRateEl.textContent = `${Math.min(rate, 100)}%`;
      }
    }

    // 生成日历
    function generateCalendar(year, month) {
      const entries = getEntries();
      const entriesByDate = {};
      
      entries.forEach(entry => {
        entriesByDate[entry.date] = true;
      });
      
      // 更新当前月份显示
      const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
      currentMonthEl.textContent = `${year}年${monthNames[month]}`;
      
      // 清空日历
      calendarDaysEl.innerHTML = '';
      
      // 获取当月第一天是星期几
      const firstDay = new Date(year, month, 1).getDay();
      
      // 获取当月的天数
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // 添加上个月的占位日期
      for (let i = 0; i < firstDay; i++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'h-10 flex items-center justify-center text-gray-300';
        calendarDaysEl.appendChild(dayEl);
      }
      
      // 添加当月的日期
      for (let i = 1; i <= daysInMonth; i++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        const hasEntry = entriesByDate[dateStr];
        
        const dayEl = document.createElement('div');
        dayEl.className = `h-10 flex items-center justify-center rounded-full cursor-pointer transition-all duration-300 ${hasEntry ? 'bg-primary/10 text-primary font-medium' : 'text-gray-600 hover:bg-gray-100'}`;
        dayEl.textContent = i;
        
        // 如果是今天，添加特殊样式
        const today = new Date().toISOString().split('T')[0];
        if (dateStr === today) {
          dayEl.className += ' ring-2 ring-primary';
        }
        
        calendarDaysEl.appendChild(dayEl);
      }
    }

    // 月份切换事件
    prevMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      updateStats();
    });

    nextMonthBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      updateStats();
    });

    // 切换暗黑模式（简单实现）
    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark');
      const icon = themeToggle.querySelector('i');
      
      if (isDark) {
        icon.classList.remove('fa-moon-o');
        icon.classList.add('fa-sun-o');
        document.body.classList.add('bg-gray-900', 'text-white');
        document.body.classList.remove('bg-light');
      } else {
        icon.classList.remove('fa-sun-o');
        icon.classList.add('fa-moon-o');
        document.body.classList.remove('bg-gray-900', 'text-white');
        document.body.classList.add('bg-light');
      }
    }

    // 事件监听
    journalForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      // 收集表单数据
      const entry = {
        id: Date.now(),
        date: dateInput.value,
        event: document.getElementById('event').value,
        object: document.getElementById('object').value,
        myFeelings: document.getElementById('my-feelings').value,
        myNeeds: document.getElementById('my-needs').value,
        theirFeelings: document.getElementById('their-feelings').value,
        theirNeeds: document.getElementById('their-needs').value,
        compassionFeelings: document.getElementById('compassion-feelings').value,
        timestamp: new Date().toISOString()
      };
      
      // 保存条目
      saveEntry(entry);
      
      // 重置表单，但保留日期
      journalForm.reset();
      dateInput.value = today;
    });

    // 历史记录按钮
    historyBtn.addEventListener('click', () => {
      historyModal.classList.remove('hidden');
      showAllEntries();
      // 防止背景滚动
      document.body.style.overflow = 'hidden';
    });

    // 关闭模态框
    closeModal.addEventListener('click', () => {
      historyModal.classList.add('hidden');
      // 恢复背景滚动
      document.body.style.overflow = '';
    });

    // 点击模态框外部关闭
    historyModal.addEventListener('click', (e) => {
      if (e.target === historyModal) {
        historyModal.classList.add('hidden');
        document.body.style.overflow = '';
      }
    });

    // 导出按钮
    exportBtn.addEventListener('click', exportData);

    // 清空历史按钮
    clearHistory.addEventListener('click', clearAllEntries);

    // 主题切换
    themeToggle.addEventListener('click', toggleTheme);

    // 初始化
    updateEntriesDisplay();
    updateStats();

    // 添加键盘事件支持
    document.addEventListener('keydown', (e) => {
      // ESC键关闭模态框
      if (e.key === 'Escape' && !historyModal.classList.contains('hidden')) {
        historyModal.classList.add('hidden');
        document.body.style.overflow = '';
      }
    });

    // 注册Service Worker (PWA功能)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('Service Worker注册成功:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker注册失败:', error);
          });
      });
    }
  </script>
</body>
</html>